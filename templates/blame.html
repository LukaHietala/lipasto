{% extends "base.html" %}

{% block content %}
<style id="blame-style"></style>
<h2>Blame: {{ path }}</h2>
<div id="loading">Loading blame information, this may take a while for large files...</div>
<div id="pomeranian" style="display: none;">
    <p>Server is taking its time... anyways, here's a tug of war match between two toasted pomeranians:</p>
    <iframe width="560" height="315" src="https://www.youtube.com/embed/Q-KciIbk_oA?si=c_DqdaVbYMlfhxW7&amp;controls=0&amp;autoplay=1" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
</div>
<div id="blame-content" style="display: none;">
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const repoName = window.location.pathname.split('/')[1];
    const loading = document.getElementById('loading');
    const pomeranian = document.getElementById('pomeranian');
    const pomeranianIframe = pomeranian.querySelector('iframe');
    const blameContent = document.getElementById('blame-content');

    const showPomeranian = () => {
        loading.style.display = 'none';
        pomeranian.style.display = 'block';
    };

    const hidePomeranian = () => {
        pomeranian.style.display = 'none';
        if (pomeranianIframe) {
            pomeranianIframe.src = 'about:blank';
        }
    };

    const pomeranianTimeout = setTimeout(showPomeranian, 5000);
    
    fetch(window.location.href, {
        headers: {
            // let server know that this is ajax
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        clearTimeout(pomeranianTimeout);
        document.getElementById('blame-style').innerHTML = data.style;
        
        // add blame content, previosly templating
        let content = '<div class="blame-code"><pre>';
        if (data.blame && data.blame.length > 0) {
            data.blame.forEach(line => {
                content += `${String(line.line_num).padStart(4)} `;
                if (line.blame) {
                    content += `<a href="/${repoName}/commits/${line.blame.commit_id}">${line.blame.commit_id.substring(0, 8)}</a> ${line.blame.author.name.substring(0, 15).padEnd(15)} ${new Date(line.blame.author.time * 1000).toISOString().slice(0, 19).replace('T', ' ')}`;
                }
                content += ` | ${line.highlighted}\n`;
            });
        } else {
            content += 'No blame info';
        }
        content += '</pre></div>';
        
        blameContent.innerHTML = content;
        loading.style.display = 'none';
        hidePomeranian();
        blameContent.style.display = 'block';
    })
    .catch(error => {
        clearTimeout(pomeranianTimeout);
        loading.innerHTML = 'Error loading blame';
        hidePomeranian();
    });
});
</script>
{% endblock %}